# Healthcare Microservices CI Pipeline
# Focus: Build, Test, Package using Dockerfiles (No Deployment)

# Workflow rules - only run on MR to develop/main and direct pushes to develop/main
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")
      when: always
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main"
      when: always
    - when: never

variables:
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: ""
  DOCKER_HOST: tcp://docker:2375
  # Container Registry
  REGISTRY: registry.gitlab.com/healthcare5314327/microservices

stages:
  - validate
  - build
  - test
  - security
  - package

# Project structure validation
validate-project:
  stage: validate
  image: alpine:latest
  rules:
    # Run on merge requests to develop/main
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")
      when: always
    # Run on direct pushes to develop/main
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main"
      when: always
    - when: never
  script:
    - echo "ğŸ” Validating project structure..."
    - |
      if [ ! -f "compose.yml" ]; then
        echo "âŒ compose.yml not found"
        exit 1
      fi
    - |
      if [ ! -d "iam-service" ] || [ ! -d "patient-service" ]; then
        echo "âŒ Required service directories not found"
        exit 1
      fi
    - echo "âœ… Project structure validation passed"

# Include service-specific CI configurations
include:
  - local: 'iam-service/.gitlab-ci.yml'
  - local: 'patient-service/.gitlab-ci.yml'

# Dependency Security Scanning
dependency-scanning:
  stage: security
  image: maven:3.9.4-eclipse-temurin-21
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")
      when: always
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main"
      when: always
    - when: never
  script:
    - echo "ğŸ”’ Running dependency security scan..."
    - |
      for service in iam-service patient-service; do
        if [ -d "$service" ]; then
          cd "$service"
          echo "Scanning $service dependencies..."
          mvn org.owasp:dependency-check-maven:check || true
          cd ..
        fi
      done
  artifacts:
    reports:
      dependency_scanning: "*/target/dependency-check-report.xml"
    expire_in: 1 week
  allow_failure: true

# Generate build summary
build-summary:
  stage: package
  image: alpine:latest
  rules:
    - if: $CI_PIPELINE_SOURCE == "merge_request_event" && ($CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "develop" || $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == "main")
      when: always
    - if: $CI_COMMIT_BRANCH == "develop" || $CI_COMMIT_BRANCH == "main"
      when: always
    - when: never
  script:
    - echo "ğŸ“Š Generating CI build summary..."
    - |
      cat > build-summary.md << 'EOF'
      # ğŸ¥ Healthcare Microservices Build Summary
      
      ## âœ… CI Pipeline Completed Successfully
      
      **Build Information:**
      - Java Version: OpenJDK 21 (via Dockerfile)
      - Maven Version: 3.9.4 (via Dockerfile)
      - Build Method: Multi-stage Docker builds
      - Build Date: $(date)
      - Git Commit: $CI_COMMIT_SHA
      - Git Branch: $CI_COMMIT_REF_NAME
      
      **Services Built:**
      - ğŸ” IAM Service
      - ğŸ‘¥ Patient Service
      
      **Artifacts Created:**
      - JAR files (extracted from Docker builds)
      - Docker images (using your optimized Dockerfiles)
      - Security scan reports
      
      **Next Steps:**
      - Review security scan results
      - Download artifacts for manual deployment
      - Set up deployment pipeline when ready
      
      **Docker Images Available:**
      - registry.gitlab.com/healthcare5314327/microservices/iam-service:DATETIME-TAG
      - registry.gitlab.com/healthcare5314327/microservices/patient-service:DATETIME-TAG
      
      Note: DATETIME-TAG format is YYYYMMDD-HHMMSS (e.g., 20250713-142530)
      EOF
    - echo "âœ… Build summary created"
  artifacts:
    paths:
      - build-summary.md
    expire_in: 1 week