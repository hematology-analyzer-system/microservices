<!DOCTYPE html>
<html>
<head>
    <title>TestOrder WebSocket Test</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7/bundles/stomp.umd.min.js"></script>
</head>
<body>
    <h1>TestOrder WebSocket Test</h1>
    
    <div>
        <h3>JWT Token Setup:</h3>
        <input type="text" id="jwtToken" placeholder="Paste your JWT token here" style="width: 500px;">
        <button onclick="setToken()">Set Token</button>
        <div id="tokenStatus" style="margin-top: 5px; font-size: 12px;"></div>
    </div>

    <div style="margin-top: 15px;">
        <h3>Connection Status: <span id="status">Disconnected</span></h3>
        <button onclick="connect()">Connect</button>
        <button onclick="disconnect()">Disconnect</button>
    </div>

    <div style="margin-top: 20px;">
        <h3>Subscriptions:</h3>
        <button onclick="subscribeToAll()">Subscribe to All Notifications</button>
        <button onclick="subscribeToCreated()">Subscribe to Created</button>
        <button onclick="subscribeToUpdated()">Subscribe to Updated</button>
        <button onclick="subscribeToUrgent()">Subscribe to Urgent</button>
    </div>

    <div style="margin-top: 20px;">
        <h3>API Testing:</h3>
        <button onclick="testCreateOrder()">Test Create Order</button>
        <button onclick="testUpdateOrder()">Test Update Order</button>
        <button onclick="getNotifications()">Get Notifications</button>
        <button onclick="getUnreadCount()">Get Unread Count</button>
    </div>

    <div style="margin-top: 20px;">
        <h3>Received Messages:</h3>
        <div id="messages" style="border: 1px solid #ccc; height: 300px; overflow-y: scroll; padding: 10px;"></div>
        <button onclick="clearMessages()">Clear Messages</button>
    </div>

    <script>
        let stompClient = null;
        let subscriptions = [];
        let jwtToken = null;
        let lastCreatedOrderId = null;

        function connect() {
            const socket = new SockJS('http://localhost:8082/testorder/ws');
            stompClient = new StompJs.Client({
                webSocketFactory: () => socket,
                debug: function (str) {
                    console.log('STOMP: ' + str);
                },
                onConnect: function (frame) {
                    console.log('Connected: ' + frame);
                    document.getElementById('status').textContent = 'Connected';
                    document.getElementById('status').style.color = 'green';
                },
                onStompError: function (frame) {
                    console.error('Broker reported error: ' + frame.headers['message']);
                    console.error('Additional details: ' + frame.body);
                    document.getElementById('status').textContent = 'Error';
                    document.getElementById('status').style.color = 'red';
                },
                onDisconnect: function () {
                    console.log('Disconnected');
                    document.getElementById('status').textContent = 'Disconnected';
                    document.getElementById('status').style.color = 'red';
                }
            });

            stompClient.activate();
        }

        function disconnect() {
            if (stompClient !== null) {
                stompClient.deactivate();
            }
        }

        function subscribeToAll() {
            if (stompClient && stompClient.connected) {
                const subscription = stompClient.subscribe('/topic/testorder', function (notification) {
                    const event = JSON.parse(notification.body);
                    displayMessage('ALL', event);
                });
                subscriptions.push(subscription);
                console.log('Subscribed to /topic/testorder');
            }
        }

        function subscribeToCreated() {
            if (stompClient && stompClient.connected) {
                const subscription = stompClient.subscribe('/topic/testorder/created', function (notification) {
                    const event = JSON.parse(notification.body);
                    displayMessage('CREATED', event);
                });
                subscriptions.push(subscription);
                console.log('Subscribed to /topic/testorder/created');
            }
        }

        function subscribeToUpdated() {
            if (stompClient && stompClient.connected) {
                const subscription = stompClient.subscribe('/topic/testorder/updated', function (notification) {
                    const event = JSON.parse(notification.body);
                    displayMessage('UPDATED', event);
                });
                subscriptions.push(subscription);
                console.log('Subscribed to /topic/testorder/updated');
            }
        }

        function subscribeToUrgent() {
            if (stompClient && stompClient.connected) {
                const subscription = stompClient.subscribe('/topic/testorder/urgent', function (notification) {
                    const event = JSON.parse(notification.body);
                    displayMessage('URGENT', event);
                });
                subscriptions.push(subscription);
                console.log('Subscribed to /topic/testorder/urgent');
            }
        }

        function displayMessage(topic, event) {
            const messagesDiv = document.getElementById('messages');
            const messageElement = document.createElement('div');
            messageElement.style.marginBottom = '10px';
            messageElement.style.padding = '5px';
            messageElement.style.border = '1px solid #ddd';
            messageElement.style.backgroundColor = topic === 'URGENT' ? '#ffebee' : '#f5f5f5';
            
            const timestamp = new Date().toLocaleTimeString();
            messageElement.innerHTML = `
                <strong>[${timestamp}] ${topic}:</strong><br>
                <strong>Title:</strong> ${event.title}<br>
                <strong>Message:</strong> ${event.message}<br>
                <strong>Action:</strong> ${event.action}<br>
                <strong>Entity ID:</strong> ${event.entityId}<br>
                <strong>Event ID:</strong> ${event.eventId}<br>
                <details>
                    <summary>Full Event Data</summary>
                    <pre>${JSON.stringify(event, null, 2)}</pre>
                </details>
            `;
            
            messagesDiv.appendChild(messageElement);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
        }

        // JWT Token functions
        function setToken() {
            const tokenInput = document.getElementById('jwtToken');
            jwtToken = tokenInput.value.trim();
            
            if (jwtToken) {
                // Test token validity
                fetch('http://localhost:8082/testorder/notifications/health', {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                })
                .then(response => {
                    console.log(response)
                    if (response.ok) {
                        document.getElementById('tokenStatus').innerHTML = 
                            '<span style="color: green;">✅ Token is valid</span>';
                    } else {
                        document.getElementById('tokenStatus').innerHTML = 
                            '<span style="color: red;">❌ Token is invalid</span>';
                    }
                })
                .catch(error => {
                    document.getElementById('tokenStatus').innerHTML = 
                        '<span style="color: red;">❌ Failed to validate token</span>';
                });
            }
        }

        // API Testing functions
        async function testCreateOrder() {
            if (!jwtToken) {
                alert('Please set JWT token first!');
                return;
            }

            const testData = {
                fullName: 'WebSocket Test User',
                email: 'websocxket.tdest@example.com',
                address: '123 WebSocket Test St',
                phoneNumber: '0123456789',
                dateOfBirth: '01/01/2000',
                gender: 'MALE'
            };

            try {
                const response = await fetch('http://localhost:8082/testorder/testorder/create', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(testData)
                });

                if (response.ok) {
                    const result = await response.json();
                    lastCreatedOrderId = result.testId;
                    displayMessage('API', {
                        title: 'API Success',
                        message: `Test Order created with ID: ${result.testId}`,
                        action: 'CREATE_API',
                        entityId: result.testId,
                        eventId: 'manual-api-test'
                    });
                } else {
                    displayMessage('API_ERROR', {
                        title: 'API Error',
                        message: `Failed to create order: ${response.status} ${response.statusText}`,
                        action: 'ERROR',
                        entityId: 'N/A',
                        eventId: 'error'
                    });
                }
            } catch (error) {
                displayMessage('API_ERROR', {
                    title: 'API Error',
                    message: `Network error: ${error.message}`,
                    action: 'ERROR',
                    entityId: 'N/A',
                    eventId: 'error'
                });
            }
        }

        async function testUpdateOrder() {
            if (!jwtToken) {
                alert('Please set JWT token first!');
                return;
            }

            if (!lastCreatedOrderId) {
                alert('Please create an order first!');
                return;
            }

            const updateData = {
                fullName: 'WebSocket Test User Updated',
                address: '456 Updated WebSocket St',
                phone: '0987654321',
                dateOfBirth: '1990-01-01',
                gender: 'MALE'
            };

            try {
                const response = await fetch(`http://localhost:8082/testorder/testorders/${lastCreatedOrderId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${jwtToken}`
                    },
                    body: JSON.stringify(updateData)
                });

                if (response.ok) {
                    const result = await response.json();
                    displayMessage('API', {
                        title: 'API Success',
                        message: `Test Order ${lastCreatedOrderId} updated successfully`,
                        action: 'UPDATE_API',
                        entityId: lastCreatedOrderId,
                        eventId: 'manual-api-test'
                    });
                } else {
                    displayMessage('API_ERROR', {
                        title: 'API Error',
                        message: `Failed to update order: ${response.status} ${response.statusText}`,
                        action: 'ERROR',
                        entityId: lastCreatedOrderId,
                        eventId: 'error'
                    });
                }
            } catch (error) {
                displayMessage('API_ERROR', {
                    title: 'API Error',
                    message: `Network error: ${error.message}`,
                    action: 'ERROR',
                    entityId: lastCreatedOrderId,
                    eventId: 'error'
                });
            }
        }

        async function getNotifications() {
            if (!jwtToken) {
                alert('Please set JWT token first!');
                return;
            }

            try {
                const response = await fetch('http://localhost:8082/testorder/notifications', {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (response.ok) {
                    const notifications = await response.json();
                    displayMessage('API', {
                        title: 'Notifications Retrieved',
                        message: `Found ${notifications.length} notifications`,
                        action: 'GET_NOTIFICATIONS',
                        entityId: 'N/A',
                        eventId: 'api-get',
                        data: notifications.slice(0, 3) // Show first 3
                    });
                } else {
                    displayMessage('API_ERROR', {
                        title: 'API Error',
                        message: `Failed to get notifications: ${response.status}`,
                        action: 'ERROR',
                        entityId: 'N/A',
                        eventId: 'error'
                    });
                }
            } catch (error) {
                displayMessage('API_ERROR', {
                    title: 'API Error',
                    message: `Network error: ${error.message}`,
                    action: 'ERROR',
                    entityId: 'N/A',
                    eventId: 'error'
                });
            }
        }

        async function getUnreadCount() {
            if (!jwtToken) {
                alert('Please set JWT token first!');
                return;
            }

            try {
                const response = await fetch('http://localhost:8082/testorder/notifications/unread-count', {
                    headers: {
                        'Authorization': `Bearer ${jwtToken}`
                    }
                });

                if (response.ok) {
                    const count = await response.text();
                    displayMessage('API', {
                        title: 'Unread Count',
                        message: `You have ${count} unread notifications`,
                        action: 'GET_UNREAD_COUNT',
                        entityId: 'N/A',
                        eventId: 'api-count'
                    });
                } else {
                    displayMessage('API_ERROR', {
                        title: 'API Error',
                        message: `Failed to get unread count: ${response.status}`,
                        action: 'ERROR',
                        entityId: 'N/A',
                        eventId: 'error'
                    });
                }
            } catch (error) {
                displayMessage('API_ERROR', {
                    title: 'API Error',
                    message: `Network error: ${error.message}`,
                    action: 'ERROR',
                    entityId: 'N/A',
                    eventId: 'error'
                });
            }
        }

        // Auto-connect when page loads
        window.onload = function() {
            connect();
        };

        // Cleanup on page unload
        window.onbeforeunload = function() {
            disconnect();
        };
    </script>
</body>
</html>
